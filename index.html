<html>

<head>
    <title>Tetris</title>
    <link href="https://fonts.googleapis.com/css?family=Roboto+Mono" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto Mono', monospace;
            margin: 0;
        }

        h1 {
            background: #e74c3c;
            padding: 20px;
            text-align: center;
            color: #fff
        }

        .game-viewport {
            margin: 0px auto;
            border: 1px black solid;
        }

        .container {
            width: 800px;
            margin: 0px auto;
        }
    </style>
</head>

<body>
    <header>
        <h1>Tetris</h1>
    </header>
    <div>
        <div class="container">
            <canvas id="game-viewport" class="game-viewport" width="200" height="480"></canvas>

            <h2>About</h2>
            <p><b>A</b> (left) and <b>D</b> (right) move the tetromino sideways. <b>W</b> rotates the tetromino
                clockwise. <b>S</b> drops the tetromino one row.</p>
        </div>
    </div>
</body>

<script>
    var i = {
        name: "I",
        rotations: [
            0x0F00, 0x2222, 0x00F0, 0x4444
        ],
        color: 'red'
    };

    var j = {
        name: "J",
        rotations: [
            0x8E00, 0x6440, 0x0E20, 0x44C0
        ],
        color: 'orange'
    }

    var l = {
        name: "L",
        rotations: [
            0x2E00, 0x4460, 0x0E80, 0xC440
        ],
        color: 'yellow'
    }

    var o = {
        name: "O",
        rotations: [
            0x6600, 0x6600, 0x6600, 0x6600
        ],
        color: 'yellowgreen'
    }

    var s = {
        name: "S",
        rotations: [
            0x6C00, 0x4620, 0x06C0, 0x8C40
        ],
        color: 'blue'
    }

    var t = {
        name: "T",
        rotations: [
            0x4E00, 0x4640, 0x0E40, 0x4C40
        ],
        color: 'cyan'
    }

    var z = {
        name: "Z",
        rotations: [
            0xC600, 0x2640, 0x0C60, 0x4C80
        ],
        color: 'magenta'
    }

    function random(min, max) {
        min = Math.ceil(min);
        max = Math.floor(max);
        return Math.floor(Math.random() * (max - min)) + min;
    }

    function setRandomShape() {
        if (state.pieces.length == 0) {
            state.pieces = [i, i, i, i, j, j, j, j, l, l, l, l, o, o, o, o, s, s, s, s, t, t, t, t, z, z, z, z];
        }

        var shape = state.pieces.splice(random(0, state.pieces.length - 1), 1)[0];
        state.currentShape = shape;
        state.rotationIdx = 0;
        state.x = 4;
        state.y = 0;
    }

    function drop() {
        if (!move(DIR.down)) {
            setRandomShape();
        }
    }

    function move(direction) {
        var nextX = state.x;
        var nextY = state.y;

        switch (direction) {
            case DIR.left:
                nextX--;
                break;
            case DIR.right:
                nextX++;
                break;
            case DIR.down:
                nextY++;
                break;
        }

        if (occupied(nextX, nextY, state.currentShape, state.rotationIdx)) {
            return false;
        }

        state.x = nextX;
        state.y = nextY;

        return true;
    }

    function occupied(x, y, shape, rotationIdx) {
        var result = false;

        each(x, y, shape, rotationIdx, function (x, y) {
            if ((x < 0) || (x * blockSize >= width) || (y < 0) || (y * blockSize >= height)) {
                result = true;
            }
        })

        return result;
    }

    // Constants

    const blockSize = 20;
    const stepTime = 1;

    const canvas = document.getElementById("game-viewport");
    const width = canvas.width;
    const height = canvas.height;
    const ctx = canvas.getContext("2d");

    const DIR = {
        left: "left",
        right: "Right",
        up: "up",
        down: "Down"
    }

    // Game State

    let state = {
        rotationIdx: 0,
        currentShape: null,
        timePlayed: 0,
        x: 0,
        y: 0,
        actions: [],
        pieces: []
    }

    // Input

    var keyMap = {
        87: DIR.up, // w
        65: DIR.left, // a
        83: DIR.down, // s
        68: DIR.right, // d
    }

    function keyup(event) {
        var key = keyMap[event.keyCode];
        state.actions.push(key);
    }

    window.addEventListener("keyup", keyup, false);

    // Game Loop

    function update(progress) {

        var nextAction = state.actions.shift();

        switch (nextAction) {
            case DIR.left:
                move(DIR.left);
                break;
            case DIR.right:
                move(DIR.right);
                break;
            case DIR.up:
                rotate();
                break;
            case DIR.down:
                drop();
                break;
        }

        state.timePlayed += progress;
        if (state.timePlayed > stepTime) {
            drop();
            state.timePlayed -= stepTime;
        }
    }

    function drawBlock(x, y, color) {
        ctx.save();

        ctx.lineWidth = 1;
        ctx.translate(0.5, 0.5);

        ctx.fillStyle = color;
        ctx.fillRect(x * blockSize, y * blockSize, blockSize, blockSize);
        ctx.strokeStyle = 'black';
        ctx.strokeRect(x * blockSize, y * blockSize, blockSize, blockSize);

        ctx.restore();
    }

    function rotate() {
        // Each shape has exactly 4 rotations
        var nextIndex = state.rotationIdx == 3 ? 0 : state.rotationIdx + 1;

        if (!occupied(state.x, state.y, state.currentShape, nextIndex)) {
            state.rotationIdx = nextIndex;
        }
    }

    function draw() {
        ctx.save();

        ctx.clearRect(0, 0, width, height);
        ctx.fillStyle = '#eee';
        ctx.fillRect(0, 0, width, height);

        each(state.x, state.y, state.currentShape, state.rotationIdx, drawBlock);

        ctx.restore();
    }

    function each(x, y, shape, rotationIdx, func) {
        var row = 0;
        var col = 0;
        var rotation = shape.rotations[rotationIdx];

        for (var bit = 0x8000; bit > 0; bit = bit >> 1) {
            if (rotation & bit) {
                func(col + x, row + y, shape.color);
            }

            if (++col === 4) {
                col = 0;
                ++row;
            }
        }
    }

    function run() {
        function loop(timestamp) {
            var progress = timestamp - lastRender;

            update(progress / 1000);
            draw();

            lastRender = timestamp;
            window.requestAnimationFrame(loop);
        }

        var lastRender = 0;
        window.requestAnimationFrame(loop);

        // Reset game etc
            setRandomShape();

    }

    run();
</script>

</html>