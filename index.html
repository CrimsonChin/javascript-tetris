<html>

<head>
    <title>Tetris</title>
    <link href="https://fonts.googleapis.com/css?family=Roboto+Mono" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto Mono', monospace;
            margin: 0;
        }

        h1 {
            background: #e74c3c;
            padding: 20px;
            text-align: center;
            color: #fff
        }

        .game-viewport {
            margin: 0px auto;
            border: 1px black solid;
        }

        .container {
            width: 800px;
            margin: 0px auto;
        }
    </style>
</head>

<body>
    <header>
        <h1>Tetris</h1>
    </header>
    <div>
        <div class="container">
            <canvas id="game-viewport" class="game-viewport" width="200" height="480"></canvas>

            <h2>About</h2>
            Left and right move the tetromino sideways. Up rotates the tetromino clockwise. Down drops the tetromino
            one row.
        </div>
    </div>
</body>

<script>
    var i = {
        name: "I",
        rotations: [
            0x0F00, 0x2222, 0x00F0, 0x4444
        ],
        color: 'red'
    };

    var j = {
        name: "J",
        rotations: [
            0x8E00, 0x6440, 0x0E20, 0x44C0
        ],
        color: 'orange'
    }

    var l = {
        name: "L",
        rotations: [
            0x2E00, 0x4460, 0x0E80, 0xC440
        ],
        color: 'yellow'
    }

    var o = {
        name: "O",
        rotations: [
            0x6600, 0x6600, 0x6600, 0x6600
        ],
        color: 'green'
    }

    var s = {
        name: "S",
        rotations: [
            0x6C00, 0x4620, 0x06C0, 0x8C40
        ],
        color: 'blue'
    }

    var t = {
        name: "T",
        rotations: [
            0x4E00, 0x4640, 0x0E40, 0x4C40
        ],
        color: 'cyan'
    }

    var z = {
        name: "Z",
        rotations: [
            0xC600, 0x2640, 0x0C60, 0x4C80
        ],
        color: 'magenta'
    }

    function drop() {
        state.y += 1;
    }

    function move(dir) {
        var nextX = state.x + dir;
        if (!occupied(nextX, state.y, state.currentShape.color)){
            state.x += dir;
        };
    }

    function occupied(x, y, color) {
        var result = false;

        each(function(x, y, color) {
            if ((x < 0) || (x*blockSize >= width) || (y < 0) || (y*blockSize >= height)) {
                result = true;
            }
        })

        return result;
    }

    var blockSize = 20;
    var stepTime = 2;

    var canvas = document.getElementById("game-viewport");
    var width = canvas.width;
    var height = canvas.height;
    var ctx = canvas.getContext("2d");
    var speed = 1;

    // Game State

    let state = {
        currentRotationIndex: 0,
        currentShape: s,
        timePlayed: 0,
        x: 5,
        y: 0,
        actions: []
    }

    // Input

    var DIR = {
        up: "up",
        down: "down",
        left: "left",
        right: "right"
    }

    var keyMap = {
        87: DIR.up, // w
        65: DIR.left, // a
        83: DIR.down, // s
        68: DIR.right, // d
    }

    function keyup(event) {
        var key = keyMap[event.keyCode];
        state.actions.push(key);
    }

    window.addEventListener("keyup", keyup, false);

    // Game Loop

    function update(progress) {

        var nextAction = state.actions.shift();

        switch (nextAction) {
            case DIR.left:
                move(-1);
                break;
            case DIR.right:
                move(1);
                break;
            case DIR.up:
                rotate();
                break;
            case DIR.down:
                drop();
                break;
        }

        state.timePlayed += progress;
        if (state.timePlayed > stepTime) {
            drop();
            state.timePlayed -= stepTime;
        }
    }

    function drawBlock(x, y, color) {
        ctx.fillStyle = color;
        ctx.fillRect(x * blockSize, y * blockSize, blockSize, blockSize);

        ctx.save();
    }

    function rotate() {
        var nextIndex = state.currentRotationIndex + 1;
        state.currentRotationIndex = nextIndex >= state.currentShape.rotations.length ? 0 : nextIndex;
    }

    function draw() {
        ctx.clearRect(0, 0, width, height);

        each(drawBlock);
    }

    function each(func) {
        var row = 0;
        var col = 0;

        for (var bit = 0x8000; bit > 0; bit = bit >> 1) {
            if (state.currentShape.rotations[state.currentRotationIndex] & bit) {
                func(col + state.x, row + state.y, state.currentShape.color);
            }

            if (++col === 4) {
                col = 0;
                ++row;
            }
        }
    }

    function run() {
        function loop(timestamp) {
            var progress = timestamp - lastRender;

            update(progress / 1000);
            draw();

            lastRender = timestamp;
            window.requestAnimationFrame(loop);
        }

        var lastRender = 0;
        window.requestAnimationFrame(loop);
    }

    run();
</script>

</html>