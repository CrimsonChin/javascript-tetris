<html>

<head>
    <title>Tetris</title>
    <link href="https://fonts.googleapis.com/css?family=Roboto+Mono" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto Mono', monospace;
            margin: 0;
        }

        button:hover {
            background: #2E88C5;
        }

        h1 {
            background: #e74c3c;
            padding: 20px;
            text-align: center;
            color: #fff
        }

        .game-viewport {
            margin: 0px auto;
            border: 1px black solid;
        }

        .container {
            width: 800px;
            margin: 0px auto;
        }

    </style>
</head>

<body>
    <header>
        <h1>Tetris</h1>
    </header>
    <div>
        <div class="container">
            <canvas id="game-viewport" class="game-viewport" width="100" height="240"></canvas>

            <h2>About</h2>
            Left and right move the tetromino sideways. Up rotates the tetromino clockwise. Down drops the tetromino
            one row.
        </div>
    </div>
</body>

<script>
    var i = {
        name: "I",
        rotations: [
            0x0F00, 0x2222, 0x00F0, 0x4444
        ]
    };

    var j = {
        name: "J",
        rotations: [
            0x8E00, 0x6440, 0x0E20, 0x44C0
        ]
    }

    var l = {
        name: "L",
        rotations: [
            0x2E00, 0x4460, 0x0E80, 0xC440
        ]
    }

    var o = {
        name: "O",
        rotations: [
            0x6600, 0x6600, 0x6600, 0x6600
        ]
    }

    var s = {
        name: "S",
        rotations: [
            0x6C00, 0x4620, 0x06C0, 0x8C40
        ]
    }

    var t = {
        name: "T",
        rotations: [
            0x4E00, 0x4640, 0x0E40, 0x4C40
        ]
    }

    var z = {
        name: "Z",
        rotations: [
            0xC600, 0x2640, 0x0C60, 0x4C80
        ]
    }

    function drawRotation(rotation) {
        var result = "";
        var row = 0;
        var col = 0;

        for (var bit = 0x8000; bit > 0; bit = bit >> 1) {
            if (rotation & bit) {
                result += "1";
            } else {
                result += "0";
            }

            if (++col === 4) {
                result += "\n";
                col = 0;
                ++row;
            }
        }

        console.log(result);
    }

    function drawRotations(tetromino) {
        console.log(tetromino.name);
        for (var i = 0; i < tetromino.rotations.length; i++) {
            drawRotation(tetromino.rotations[i]);
            console.log();
        }
    }

    // var tetrominoes = [i, j, l, o, s, t, z];

    // tetrominoes.forEach(tetromino => {
    //     drawRotations(tetromino);
    // });

    function drop() {
        state.y += 10;
    }

    var blockSize = 10;
    var stepTime = 5;


    var canvas = document.getElementById("game-viewport");
    var width = canvas.width;
    var height = canvas.height;
    var ctx = canvas.getContext("2d");
    var speed = 1;

    // Game State

    let state = {
        timePlayed: 0,
        x: width / 2,
        y: 0,
        pressedKeys: {
            left: false,
            right: false,
            up: false,
            down: false
        }
    }

    // Input

    var keyMap = {
        87: 'up', // w
        65: 'left', // a
        83: 'down', // s
        68: 'right', // d
    }

    function keydown(event) {
        var key = keyMap[event.keyCode];
        state.pressedKeys[key] = true;
    }

    function keyup(event) {
        var key = keyMap[event.keyCode];
        state.pressedKeys[key] = false;
    }

    window.addEventListener("keydown", keydown, false)
    window.addEventListener("keyup", keyup, false)

    // Game Loop

    function update(progress) {
        if (state.pressedKeys.left) {
            state.x -= speed;
        }

        if (state.pressedKeys.right) {
            state.x += speed;
        }

        if (state.pressedKeys.up) {
            // rotate
        }

        if (state.pressedKeys.down) {
            drop();
        }

        state.timePlayed += progress;
        if (state.timePlayed > stepTime) {
            drop();

            state.timePlayed -= stepTime;
        }

    }

    function draw() {
        ctx.clearRect(0, 0, width, height);

        ctx.fillRect(state.x - 5, state.y - 5, blockSize, blockSize);
        ctx.save();
    }

    function loop(timestamp) {
        var progress = timestamp - lastRender;

        update(progress / 1000.0);
        draw();

        lastRender = timestamp;
        window.requestAnimationFrame(loop);
    }
    
    var lastRender = 0;
    window.requestAnimationFrame(loop);
</script>

</html>